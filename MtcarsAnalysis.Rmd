---
title: "Requerimientos y plan de acción para extracción de muestras de datos"
author: "Ronald Rodríguez - ronaldraxon@gmail.com"
date: "Agosto 28, 2017"
output: pdf_document
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(datasets)
library(dplyr)
library(ggplot2)
library(stats)
library(car)
library(GGally)
library(tidyr) 
```

## Executive Summary

Motor Trend Magazine is interested in exploring the relationship between fuel 
consumption generally denoted as miles per gallon (MPG) and other possible related
variables found in the mtcars data set. The mtcars data comprises fuel consumption 
and 10 additional aspects of automobile design and performance for 32 automobiles
(1973-74 models). This exercise was focused on variables weight(1000 lbs) and 
automatic/manual transmission where 0 stands for automatic and 1 for manual transmission.
With these variables it is expected to answer the following questions:

1. ¿Is an automatic or manual transmission better for MPG?
2. ¿How it can be Quantified the MPG difference between automatic and manual transmissions?

Manual trasmission cars have a significant advantage over automatic cars. Weight 
seems to be a relevant variable in fuel consumption, but keeping in mind
that manual trasmision cars are in a badge between 1513lbs and 3570lbs, meanwhile 
automatic cars are in a badge betweetn 2000lbs and 5000lbs, being automatic cars 
heavier in many cases. However there are some cases when even manual cars with 
weight equivalent to the mean of the automatic cars weight giving a clear view 
that in most circumstances manual trasmission cars (with a participation of acceleration
quoted on 1/4 mile time or qsec) are better choice for fuel consumption affairs.
Toyota Corolla, Fiat 128 and Honda Civic, have the highest miles per galon.

## Exploratory Analysis

The analysis begins by performing some initial explaratory data analysis to 
get a better idea of the existing features and data patterns. First a summary of
miles per gallon, weight and transmission type is shown as follows:

```{r}
summary(mtcars$mpg)
summary(mtcars$wt)
summary(mtcars$am)
```

Normally in regression analysis scatter plot is a very effective tool. A pairwise 
scatter plot is created in order to preview the relationship among miles per galon,
weigth and transmission type as shown in fig 1. 

```{r, fig.height=4, fig.width=5,fig.align='center'}
wrappedFunction <- function(data, mapping, method="lm"){
  p <- ggplot(data = data, mapping = mapping) + 
    geom_point() + 
    geom_smooth(method=method)
  p
}
ggpairs(mtcars[c('mpg','wt','am')],title = "Figure 1. Features Correlation", 
        lower = list(continuous = wrap(wrappedFunction)))
```

## Results

###¿Is an automatic or manual transmission better for MPG?

As we are interested to know if an automatic or manual transmission better for MPG. 
Firstm hypothesis that cars with an automatic transmission use more 
fuel than cars with a manual transmission is tested. In order to compare  if two 
these two groupd have different means, we use two sample T-test.
```{r}
test <- t.test(mpg ~ am, data= mtcars, var.equal = FALSE, paired=FALSE ,conf.level = .95)
result <- data.frame( "t-statistic"  = test$statistic, 
                       "df" = test$parameter,
                        "p-value"  = test$p.value,
                        "lower CL" = test$conf.int[1],
                        "upper CL" = test$conf.int[2],
                        "automatic mean" = test$estimate[1],
                        "manual mean" = test$estimate[2],
                        row.names = "")
result
```

Here, the  p-value shows the probability that this apparent difference between 
the automaticand manual cars is very low. The confidence interval also describes 
how much lower the miles per gallon is in manual cars than it is in automatic cars. 
According the test true difference is between 3.2 and 11.3.

###2. ¿How it can be Quantified the MPG difference between automatic and manual transmissions?

Modeling based on only one predictor such as wt and am variable does not seem to 
be sufficient and good enough as we have other predictor variables that might 
affect MPG and therefore affect the difference in MPG by transmission. The univariate model 
would show only a view point. Then  multivariable linear regression will be used 
to develop a model that includes the effect of other variables. Using fitvit
command the variance inflations is shown as follows:

```{r}
library(car)
fitvif <- lm(mpg ~ cyl+disp+hp+drat+wt+qsec+factor(vs)+factor(am)+gear+carb, data = mtcars)
```

Values for inflation greater than 10 are considered large. Lets bring our 
attention to VIf values between 5 and 10. At these point we might consider
leaving only one of these variables in the model.

In order to verify the result of the selection model, we also perform the
procedure with anova.

```{r}
fit1 <- lm(mpg ~ factor(am), data = mtcars)
fit2 <- lm(mpg ~ factor(am)+wt, data = mtcars)
fit3 <- lm(mpg ~ factor(am)+wt+qsec, data = mtcars)
fit4 <- lm(mpg ~ factor(am)+wt+qsec+hp, data = mtcars)
fit5 <- lm(mpg ~ factor(am)+wt+qsec+hp+drat, data = mtcars)
anova(fit1, fit2)
```

As seen previusly the result is consistent with stepwise selection model and 
adding any more variable in addition to wt, am and qsec will rise
the variation in the model, and the p-value immediately goes drastically down. Now 
using the selected variables, we can fit the final model.

```{r}
finalfit <- lm(mpg ~ wt+qsec+factor(am), data = mtcars)
summary(finalfit)$coef
```

It can be observed that all the variables are now significant. This 
model explains approximately 84% of the variance in miles per gallon (mpg). According to the
results it can be stated that on average, manual transmission cars have 
around 2.94 miles per gallon more than automatic transmission cars.

## Appendix

```{r}
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}
```

```{r, fig.height=2, fig.width=4, echo=F, warning=F, cache=T,fig.align='center'}

p1 <- ggplot(mtcars, aes(wt, mpg, col=factor(mtcars$am, levels=c(1,0), labels=c("Manual", "Automatic"))))+
geom_boxplot(position="identity") +
theme(legend.position="top") +
scale_color_discrete(name="Transmission") +
labs(x ="Weight(1000 lbs) ", 
     y= "Miles per gallon")

```

```{r, fig.height=2, fig.width=4, echo=F, warning=F, cache=T,fig.align='center'}
p2 <- ggplot(mtcars, aes(factor(am, levels=c(1,0), labels = c("Manual","Automatic")),wt, fill=factor(am))) +
        geom_violin(colour="black", size=1,show.legend=FALSE) +
        labs(x ="Transmission Type", 
             y= "Weight(1000 lbs)") 

```

```{r}
multiplot(p1, p2, cols=2)
```

Box plot showing automatic cars and manual cars fuel consumption (on the left)
and a violin graph showing the popultation density among different weights.

```{r,fig.height=4, fig.width=7,fig.align='center'}
ggplotRegression <- function (fit) {

require(ggplot2)

ggplot(fit$model, aes_string(x = names(fit$model)[2], y = names(fit$model)[1])) + 
  geom_point() +
  stat_smooth(method = "lm", col = "red") +
  labs(title = paste("Adj R2 = ",signif(summary(fit)$adj.r.squared, 5),
                     "Intercept =",signif(fit$coef[[1]],5 ),
                     " Slope =",signif(fit$coef[[2]], 5),
                     " P =",signif(summary(fit)$coef[2,4], 5)))
}

ggplotRegression(lm(mpg ~ wt, data = mtcars))
```

```{r,fig.height=4, fig.width=7,fig.align='center'}
# Select out data of interest:
d <- mtcars %>% select(mpg, hp, wt, disp)

# Fit the model
fit <- lm(mpg ~ hp + wt+ disp, data = d)

# Obtain predicted and residual values
d$predicted <- predict(fit)
d$residuals <- residuals(fit)

ggplot(d, aes(x = hp, y = mpg)) +
  geom_segment(aes(xend = hp, yend = predicted), alpha = .2) +
  geom_point(aes(color = residuals)) +
  scale_color_gradient2(low = "blue", mid = "white", high = "red") +
  guides(color = FALSE) +
  geom_point(aes(y = predicted), shape = 1) +
  theme_bw()
```

By plotting residuals versus the fitted values, we're looking for any sort of pattern. 
Same thing with the fitted values versus the standardized, where it's plotting 
a function of the standardized residuals. Plots below shows that there is no 
a specific pattern(like heterocedasticity) in the residuals.

```{r,fig.height=4, fig.width=7,fig.align='center'}
d %>% 
  gather(key = "iv", value = "x", -mpg, -predicted, -residuals) %>%  # Get data into shape
  ggplot(aes(x = x, y = mpg)) +  # Note use of `x` here and next line
  geom_segment(aes(xend = x, yend = predicted), alpha = .2) +
  geom_point(aes(color = residuals)) +
  scale_color_gradient2(low = "blue", mid = "white", high = "red") +
  guides(color = FALSE) +
  geom_point(aes(y = predicted), shape = 1) +
  facet_grid(~ iv, scales = "free") +  # Split panels here by `iv`
  theme_bw()
```
